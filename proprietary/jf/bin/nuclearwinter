#!/system/bin/sh
export PATH=/sbin:/system/sbin:/system/bin:/system/xbin
/system/bin/logwrapper bash -c '
#### set permissions
for x in `find /sys -name cpufreq`; do for y in `ls $x`; do   
  chown system.system $x/$y
  chmod 664 $x/$y
done; done

#### handle kernels with built-in thermal and hotplug handling
needsmpdecision=
needsthermal=
[ ! -e /sys/devices/system/cpu/cpu0/cpufreq/enable_auto_hotplug ] && needsmpdecision=1
[ ! -e /sys/devices/system/cpu/cpufreq/kthermal ] && needsthermal=1

# Always, all the time
[ ! $needsthermal ] && stop `getprop qcom.thermal`

# Conditional hotplugging handing
handle_hotplug() {
  [ ! $needsmpdecision ] && stop mpdecision
  case $1 in 0) if [ $needsmpdecision ]; then
                  echo "Stopping mpdecision"
                  stop mpdecision
                else
                  echo "Disabling kernel autohotplug"
                  echo 0 > /sys/devices/system/cpu/cpu0/cpufreq/enable_auto_hotplug
                fi;;
             1) if [ $needsmpdecision ]; then
                  echo "Starting mpdecision"
                  start mpdecision
                else
                  echo "Enabling kernel autohotplug"
                  echo 1 > /sys/devices/system/cpu/cpu0/cpufreq/enable_auto_hotplug
                fi;;
  esac
  return 0;
}

# account for performance profiles
case `getprop sys.perf.profile` in
  0|1) #powersave or balanced
    handle_hotplug 1
    ;;
  2) #performance
    handle_hotplug 0
    ;;
  *) #who the fuck knows
    echo "Your phone will self destruct in 5... 4..."
    ;;
esac'
